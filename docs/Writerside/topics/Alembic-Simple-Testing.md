# 5. Alembic Simple Testing

## Test 1

Because Alembic has already been installed and configured, we can now test the database connection and model definition.

To test the database connection and model definition, we can run the following code:

```Shell
alembic revision --autogenerate -m "Create test table"
```

<procedure title="Console Output">

```text
(venv) PS C:\Users\Safet\Desktop\Student-Management-System> alembic revision --autogenerate -m "Create test table"
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'test'
Generating C:\Users\Safet\Desktop\Student-Management-System\alembic\versions\2a377fb74a24_create_test_table.py ...  done
```

</procedure>

This command generates a new migration script that creates the `test` table in the database.

```text
├── alembic/
│   ├── env.py
│   ├── README
│   ├── script.py.mako
│   └── versions/
│       └── 2a377fb74a24_create_test_table.py   # +
```

The migration script is created in the `versions/` directory with a filename that includes a unique identifier.

`2a377fb74a24_create_test_table.py`:
```Python
"""Create test table

Revision ID: 2a377fb74a24
Revises: 
Create Date: 2024-08-11 21:23:27.220848

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '2a377fb74a24'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('test',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('created_date', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('test')
    # ### end Alembic commands ###

```

Running `alembic history` will show the migration history:

```Shell
(venv) PS C:\Users\Safet\Desktop\Student-Management-System> alembic history
<base> -> 2a377fb74a24 (head), Create test table
```

Running `alembic upgrade head` will apply the latest migration:

```Shell
(venv) PS C:\Users\Safet\Desktop\Student-Management-System> alembic upgrade head
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 2a377fb74a24, Create test table
```

Now if we check the database, we should see the `test` table along with some other tables:

```Shell
test_db-# \d
               List of relations
 Schema |      Name       |   Type   |  Owner
--------+-----------------+----------+----------
 public | alembic_version | table    | postgres
 public | test            | table    | postgres
 public | test_id_seq     | sequence | postgres
(3 rows)
```

Viewing the details of the `test` table:

```Shell
test_db-# \d test
                                         Table "public.test"
    Column    |            Type             | Collation | Nullable |             Default
--------------+-----------------------------+-----------+----------+----------------------------------
 id           | integer                     |           | not null | nextval('test_id_seq'::regclass)
 created_date | timestamp without time zone |           |          |
Indexes:
    "test_pkey" PRIMARY KEY, btree (id)
```

The `test` table has been successfully created in the database.

## Test 2

What if the model is updated and a new column is added?

`models.py`:
```Python
class Test(Base):
    __tablename__ = 'test'

    id = Column(Integer, primary_key=True)
    text = Column(String)
    created_date = Column(DateTime, default=datetime.datetime.now(datetime.timezone.utc))
```

Then running `alembic revision --autogenerate -m "alter table test add column text"` will generate a new migration script:

```Shell
(venv) PS C:\Users\Safet\Desktop\Student-Management-System> alembic revision --autogenerate -m "alter table test add column text"
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.ddl.postgresql] Detected sequence named 'test_id_seq' as owned by integer column 'test(id)', assuming SERIAL and omitting
INFO  [alembic.autogenerate.compare] Detected added column 'test.text'
Generating C:\Users\Safet\Desktop\Student-Management-System\alembic\versions\33783416d54c_alter_table_test_add_column_text.py ...  done
```

The migration script `33783416d54c_alter_table_test_add_column_text.py`:

```Python
"""alter table test add column text

Revision ID: 33783416d54c
Revises: 2a377fb74a24       # This is the previous revision ID
Create Date: 2024-08-11 21:41:56.561537

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '33783416d54c'
down_revision: Union[str, None] = '2a377fb74a24'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('test', sa.Column('text', sa.String(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('test', 'text')
    # ### end Alembic commands ###

```

Then running the `alembic history`:

```Shell
(venv) PS C:\Users\Safet\Desktop\Student-Management-System> alembic history
2a377fb74a24 -> 33783416d54c (head), alter table test add column text
<base> -> 2a377fb74a24, Create test table
```

Finally running `alembic upgrade head` will apply the latest migration:

```Shell
(venv) PS C:\Users\Safet\Desktop\Student-Management-System> alembic upgrade head
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade 2a377fb74a24 -> 33783416d54c, alter table test add column text
```

Checking the database:

```Shell
test_db-# \d test
                                         Table "public.test"
    Column    |            Type             | Collation | Nullable |             Default
--------------+-----------------------------+-----------+----------+----------------------------------
 id           | integer                     |           | not null | nextval('test_id_seq'::regclass)
 created_date | timestamp without time zone |           |          |
 text         | character varying           |           |          |
Indexes:
    "test_pkey" PRIMARY KEY, btree (id)
```

The `text` column has been successfully added to the `test` table.

## Test 3

What if we wanted to go back to the previous migration?

Running `alembic downgrade -1` will revert the last migration:

```Shell
(venv) PS C:\Users\Safet\Desktop\Student-Management-System> alembic downgrade -1
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running downgrade 33783416d54c -> 2a377fb74a24, alter table test add column text
```

Checking the database:

```Shell
test_db-# \d test
                                         Table "public.test"
    Column    |            Type             | Collation | Nullable |             Default
--------------+-----------------------------+-----------+----------+----------------------------------
 id           | integer                     |           | not null | nextval('test_id_seq'::regclass)
 created_date | timestamp without time zone |           |          |
Indexes:
    "test_pkey" PRIMARY KEY, btree (id)
```

Reverting back to latest:

```Shell
(venv) PS C:\Users\Safet\Desktop\Student-Management-System> alembic upgrade head
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade 2a377fb74a24 -> 33783416d54c, alter table test add column text
```

Checking the database:

```Shell
test_db-# \d test
                                         Table "public.test"
    Column    |            Type             | Collation | Nullable |             Default
--------------+-----------------------------+-----------+----------+----------------------------------
 id           | integer                     |           | not null | nextval('test_id_seq'::regclass)
 created_date | timestamp without time zone |           |          |
 text         | character varying           |           |          |
Indexes:
    "test_pkey" PRIMARY KEY, btree (id)
```

The `text` column has been successfully added back to the `test` table.

## Summary

In this section, we have:

- Tested the database connection and model definition using Alembic migrations.
- Added a new column to the `Test` model and tested the migration process.
- Reverted the migration to the previous state and then reapplied it.
- Successfully tested the database connection and model definition with the new column.
- Demonstrated how to revert migrations using Alembic.
